<div class="page-header">
  <%= link_to fish_index_path, class: 'btn btn-default' do %>
    <span class="glyphicon glyphicon-list-alt"></span>
    Back
  <% end %>
  <%= link_to edit_fish_path(@fish), class: 'btn btn-primary' do %>
    <span class="glyphicon glyphicon-pencil"></span>
    Edit
  <% end %>
  <div class="container">
<div class="row">
  <div class="col-md-8">
    <div class="row">
      <h2><%= @fish.name %></h2>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="thumbframe">
          <%= image_tag @fish.photo.url(:med) %>
        </div>
      </div>
      <div class="col-md-6">
        <table class="table">
              <tbody>
              <tr>
                <td>
                  Название:
                </td>
                <td>
                  <%= @fish.name %>
                </td>
              </tr>
              
            </tbody>
           </table>
      </div>
    </div>
    <div class="row">
      <h2>Описание</h2>
      <%= raw(@fish.description) %>
    </div>
    <div class="row fblock" id="map" style='height: 600px;'>
  </div>

  <div class="col-md-4">
    <div class="row"><h2></h2></div>
      <div class="row">
          <table class="table">
            <tbody>
              
              
              
            </tbody>
          </table>
      </div>
  </div>
</div>
</div>

<script type="text/javascript">
        <% h = Hash.new { |h,k| h[k] = [] } %>
        <% Trophy.where(fish_id: @fish.id).each do |trophy| %>
           <% h[trophy.lat.to_s+trophy.lng.to_s][0]= trophy.id %>
           <% h[trophy.lat.to_s+trophy.lng.to_s][1]= trophy.lat %>
           <% h[trophy.lat.to_s+trophy.lng.to_s][2]= trophy.lng %>
           <% if !h[trophy.lat.to_s+trophy.lng.to_s][3].nil? %>
            <% h[trophy.lat.to_s+trophy.lng.to_s][3] << small_trophy_badge(trophy).to_s %> 
            <% else %>
              <% h[trophy.lat.to_s+trophy.lng.to_s][3]= '' %>
              <% h[trophy.lat.to_s+trophy.lng.to_s][3] << small_trophy_badge(trophy).to_s %>
            <% end %>
        <% end %>
        <% ord = h.sort_by { |k, v| v.length }.reverse %>

    var json_data = [
        <% ord.each do |key, val|%>
                  {
                          id:  <%= val[0] %>,
                          <% if !val[1].nil? %>
                            lat: <%= val[1] %>,
                            lng: <%= val[2] %>,
                          <% else %>
                            lat: 55.7500,
                            lng: 37.6167,
                          <% end %>
                          
                          description: '<%= raw(val[3]) %>'
                   },
          <% end %>
        
      
    ];

 
function initialize()
{
    var bounds = new google.maps.LatLngBounds();
    var mapProp = {
        zoom:5,
        mapTypeId:google.maps.MapTypeId.ROADMAP
    };
    var map=new google.maps.Map(document.getElementById("map"),mapProp);

    var infowindow =  new google.maps.InfoWindow({
        content: ""
    });
    var icon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAoCAYAAADpE0oSAAACy0lEQVRYR+2X3XEaQRCEWxHonAGOAPxkvwERgCMAIsBEYIgAHAEQgSECIAJDBjgC4whwfcvt6ljt3p9K1oumipJ07EzP9PTNrB70RvbwRrh6B/5vzL9TnUd1X1JPUkdSwzt4lrSXtJG0LdOvMlQDtAyAxeKTxChNJJpDEfBK0sB6J0miwWCgTqcjfm80Gjqfz+az3++13W51uVzscXxJIGgx4ETSz5RWAzQej9Xvw3bcAF0sFprNZvYQ9H+V5LKxX8SATaVUNZ/PNRwOy7TNndlsNhqNRrb6YOUh4Kmk761WS8vlUvysY8fjUd1u14JDAXGd+cCo9ZekBMqguNls1sE1PqvVylSeUv0xS7kP7MQEzbvdrlbFk8nEiI0YVJ4Kbi3J9cwHRgSPpIhju92uXO3pdIolS+wPIXHRTGg2YqK/RQYIQrKG6qmOFkXsk6Qj32UrNqLiIcF6PYZU2A6Hg6bTqWGlok0kLaLAZP34aBh/Zuv1uvLrlQni1B2s+Hq9vgYoMfOBQxXniKYK2/nAoR4zDGr01E8q2OOoqhFTjlKrVBxUtZ0wRlW8+HZqMX2YQllji1iHksi/s6vVHyBIfUwgpg5jkzXo0wwoe+o+lUL4H5K+2VM+MDFZ5KZq/kgat8sGOxeztwI4e7br4th/02qdS2g7kdWcGDSdqv6kAUmEZ4wegCuYE1WsYvvcLQuAmE/+OGHV3DgotLvlUATM9wxhMzeplHlqmp8ayXQLMc3FL3htKbpzObGBQbfpMZFIhp6YiR+2OzH5R4qArZ4ouOyOPKQE5W6QMsA2WdrNIv8i6bNXwSmVAtrIIeHJqwqw9YJpbqBZcxOpuO23E3WA8cuur7uJ9NrATvGSckUUS6RuxfTa3o24sD/df0qWXBeYt4mBxii0+6Ik5Mt6jDfq5VPt34w0vboV4878YGpWpvklqsbX7otKFNvD/wC8QdspHdhxOgAAAABJRU5ErkJggg=="
    };
    for (var i = 0, length = json_data.length; i < length; i++) {
        var data=json_data[i];
        var latLng = new google.maps.LatLng(data.lat, data.lng); 
        // Creating a marker and putting it on the map
        var marker = new google.maps.Marker({
            
            position: latLng,
            map: map,
            icon: icon
        });
        bounds.extend(marker.getPosition());
        bindInfoWindow(marker, map, infowindow, data.description);
    } 
    map.fitBounds(bounds);
}

function bindInfoWindow(marker, map, infowindow, description) {
    google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(description);
        infowindow.open(map, marker);
    });
}

google.maps.event.addDomListener(window, 'load', initialize); 
</script>
